name: Supabase migrations

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  apply:
    name: Apply Supabase migrations
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Supabase CLI
        run: npm install -g supabase
      - name: Configure Supabase
        env:
          SUPABASE_DB_URL: ${{ env.SUPABASE_DB_URL }}
          SUPABASE_PROJECT_ID: ${{ env.SUPABASE_PROJECT_ID }}
          SUPABASE_SERVICE_ROLE: ${{ env.SUPABASE_SERVICE_ROLE }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ] || [ -z "$SUPABASE_PROJECT_ID" ] || [ -z "$SUPABASE_SERVICE_ROLE" ]; then
            echo "Secrets SUPABASE_DB_URL, SUPABASE_PROJECT_ID et SUPABASE_SERVICE_ROLE requis."
            exit 1
          fi

          mkdir -p supabase
          cat <<EOF > ./supabase/.env
SUPABASE_DB_URL=$SUPABASE_DB_URL
EOF

          supabase link --project-ref "$SUPABASE_PROJECT_ID" \
            --password "$SUPABASE_SERVICE_ROLE"
      - name: Apply migrations
        env:
          SUPABASE_DB_URL: ${{ env.SUPABASE_DB_URL }}
        run: |
          supabase db push
